<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TDD演示 | MadBOK</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="shortcut icon" href="./favicon.ico">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="manifest" href="/MadBOK/manifest.json">
    <link rel="apple-touch-icon" href="./logo152.png">
    <link rel="mask-icon" href="/MadBOK/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="MadBOK for hanchenhao">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="./logo144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/MadBOK/assets/css/0.styles.a5e47809.css" as="style"><link rel="preload" href="/MadBOK/assets/js/app.4af459fe.js" as="script"><link rel="preload" href="/MadBOK/assets/js/2.60cd3182.js" as="script"><link rel="preload" href="/MadBOK/assets/js/212.88c4aee5.js" as="script"><link rel="prefetch" href="/MadBOK/assets/js/10.1550b70f.js"><link rel="prefetch" href="/MadBOK/assets/js/100.f0610c12.js"><link rel="prefetch" href="/MadBOK/assets/js/101.97c8c749.js"><link rel="prefetch" href="/MadBOK/assets/js/102.5d704a3c.js"><link rel="prefetch" href="/MadBOK/assets/js/103.7110f512.js"><link rel="prefetch" href="/MadBOK/assets/js/104.460dd344.js"><link rel="prefetch" href="/MadBOK/assets/js/105.84d4825d.js"><link rel="prefetch" href="/MadBOK/assets/js/106.a5dd18a1.js"><link rel="prefetch" href="/MadBOK/assets/js/107.66a6c312.js"><link rel="prefetch" href="/MadBOK/assets/js/108.c556a865.js"><link rel="prefetch" href="/MadBOK/assets/js/109.6dff5ca9.js"><link rel="prefetch" href="/MadBOK/assets/js/11.9207d1f0.js"><link rel="prefetch" href="/MadBOK/assets/js/110.6bcabbe9.js"><link rel="prefetch" href="/MadBOK/assets/js/111.ff42be16.js"><link rel="prefetch" href="/MadBOK/assets/js/112.4eac3dfd.js"><link rel="prefetch" href="/MadBOK/assets/js/113.3de88735.js"><link rel="prefetch" href="/MadBOK/assets/js/114.5cbe4bf7.js"><link rel="prefetch" href="/MadBOK/assets/js/115.dfa200aa.js"><link rel="prefetch" href="/MadBOK/assets/js/116.906acf16.js"><link rel="prefetch" href="/MadBOK/assets/js/117.f5391141.js"><link rel="prefetch" href="/MadBOK/assets/js/118.9cf10c03.js"><link rel="prefetch" href="/MadBOK/assets/js/119.f30030ad.js"><link rel="prefetch" href="/MadBOK/assets/js/12.5eb49229.js"><link rel="prefetch" href="/MadBOK/assets/js/120.dc485f5f.js"><link rel="prefetch" href="/MadBOK/assets/js/121.228323b3.js"><link rel="prefetch" href="/MadBOK/assets/js/122.b05cf1d5.js"><link rel="prefetch" href="/MadBOK/assets/js/123.dca96c1a.js"><link rel="prefetch" href="/MadBOK/assets/js/124.9394d1bb.js"><link rel="prefetch" href="/MadBOK/assets/js/125.3370cf79.js"><link rel="prefetch" href="/MadBOK/assets/js/126.85d59390.js"><link rel="prefetch" href="/MadBOK/assets/js/127.08f21e18.js"><link rel="prefetch" href="/MadBOK/assets/js/128.f2710042.js"><link rel="prefetch" href="/MadBOK/assets/js/129.a1197282.js"><link rel="prefetch" href="/MadBOK/assets/js/13.c1d6595f.js"><link rel="prefetch" href="/MadBOK/assets/js/130.c32dd38d.js"><link rel="prefetch" href="/MadBOK/assets/js/131.92ad996e.js"><link rel="prefetch" href="/MadBOK/assets/js/132.82d98efa.js"><link rel="prefetch" href="/MadBOK/assets/js/133.da2eee21.js"><link rel="prefetch" href="/MadBOK/assets/js/134.7620ac76.js"><link rel="prefetch" href="/MadBOK/assets/js/135.6735be6e.js"><link rel="prefetch" href="/MadBOK/assets/js/136.b40cebe8.js"><link rel="prefetch" href="/MadBOK/assets/js/137.c41bee8c.js"><link rel="prefetch" href="/MadBOK/assets/js/138.64cde72c.js"><link rel="prefetch" href="/MadBOK/assets/js/139.7188d65f.js"><link rel="prefetch" href="/MadBOK/assets/js/14.7a7786ca.js"><link rel="prefetch" href="/MadBOK/assets/js/140.47ad5fd8.js"><link rel="prefetch" href="/MadBOK/assets/js/141.1e706f01.js"><link rel="prefetch" href="/MadBOK/assets/js/142.71468b66.js"><link rel="prefetch" href="/MadBOK/assets/js/143.b814ab9a.js"><link rel="prefetch" href="/MadBOK/assets/js/144.574fa53e.js"><link rel="prefetch" href="/MadBOK/assets/js/145.ba377243.js"><link rel="prefetch" href="/MadBOK/assets/js/146.e1f05a3d.js"><link rel="prefetch" href="/MadBOK/assets/js/147.4f2e322b.js"><link rel="prefetch" href="/MadBOK/assets/js/148.7d8597ac.js"><link rel="prefetch" href="/MadBOK/assets/js/149.e5a163b2.js"><link rel="prefetch" href="/MadBOK/assets/js/15.2105ea8b.js"><link rel="prefetch" href="/MadBOK/assets/js/150.903cf8b6.js"><link rel="prefetch" href="/MadBOK/assets/js/151.85c0cce0.js"><link rel="prefetch" href="/MadBOK/assets/js/152.02bbb973.js"><link rel="prefetch" href="/MadBOK/assets/js/153.15163d47.js"><link rel="prefetch" href="/MadBOK/assets/js/154.26b6e64a.js"><link rel="prefetch" href="/MadBOK/assets/js/155.77185674.js"><link rel="prefetch" href="/MadBOK/assets/js/156.599d5124.js"><link rel="prefetch" href="/MadBOK/assets/js/157.b3eb0dee.js"><link rel="prefetch" href="/MadBOK/assets/js/158.6db6dff7.js"><link rel="prefetch" href="/MadBOK/assets/js/159.b5ff4354.js"><link rel="prefetch" href="/MadBOK/assets/js/16.b88e5249.js"><link rel="prefetch" href="/MadBOK/assets/js/160.1517e40d.js"><link rel="prefetch" href="/MadBOK/assets/js/161.1fd03ab4.js"><link rel="prefetch" href="/MadBOK/assets/js/162.34727de8.js"><link rel="prefetch" href="/MadBOK/assets/js/163.5cd24ec0.js"><link rel="prefetch" href="/MadBOK/assets/js/164.af91f31d.js"><link rel="prefetch" href="/MadBOK/assets/js/165.4a22e61e.js"><link rel="prefetch" href="/MadBOK/assets/js/166.0c2cbb3e.js"><link rel="prefetch" href="/MadBOK/assets/js/167.3700b909.js"><link rel="prefetch" href="/MadBOK/assets/js/168.c9101a77.js"><link rel="prefetch" href="/MadBOK/assets/js/169.8194a100.js"><link rel="prefetch" href="/MadBOK/assets/js/17.99d3a4bd.js"><link rel="prefetch" href="/MadBOK/assets/js/170.1220ab3a.js"><link rel="prefetch" href="/MadBOK/assets/js/171.21cf4e8a.js"><link rel="prefetch" href="/MadBOK/assets/js/172.bba0db7b.js"><link rel="prefetch" href="/MadBOK/assets/js/173.e2668744.js"><link rel="prefetch" href="/MadBOK/assets/js/174.91ac63f9.js"><link rel="prefetch" href="/MadBOK/assets/js/175.d5f7b99b.js"><link rel="prefetch" href="/MadBOK/assets/js/176.fe8d2737.js"><link rel="prefetch" href="/MadBOK/assets/js/177.c79d2683.js"><link rel="prefetch" href="/MadBOK/assets/js/178.3992c853.js"><link rel="prefetch" href="/MadBOK/assets/js/179.a1858953.js"><link rel="prefetch" href="/MadBOK/assets/js/18.577f3833.js"><link rel="prefetch" href="/MadBOK/assets/js/180.86d8893f.js"><link rel="prefetch" href="/MadBOK/assets/js/181.5cbb7413.js"><link rel="prefetch" href="/MadBOK/assets/js/182.d2f4cb64.js"><link rel="prefetch" href="/MadBOK/assets/js/183.d5eb73e2.js"><link rel="prefetch" href="/MadBOK/assets/js/184.5f6c7446.js"><link rel="prefetch" href="/MadBOK/assets/js/185.a3d29ad2.js"><link rel="prefetch" href="/MadBOK/assets/js/186.ca268829.js"><link rel="prefetch" href="/MadBOK/assets/js/187.c9929883.js"><link rel="prefetch" href="/MadBOK/assets/js/188.9655c885.js"><link rel="prefetch" href="/MadBOK/assets/js/189.5e771f2d.js"><link rel="prefetch" href="/MadBOK/assets/js/19.80b81f67.js"><link rel="prefetch" href="/MadBOK/assets/js/190.74c6ad88.js"><link rel="prefetch" href="/MadBOK/assets/js/191.a3e54700.js"><link rel="prefetch" href="/MadBOK/assets/js/192.df26d75f.js"><link rel="prefetch" href="/MadBOK/assets/js/193.7ad5c69d.js"><link rel="prefetch" href="/MadBOK/assets/js/194.f7b93f80.js"><link rel="prefetch" href="/MadBOK/assets/js/195.c68d75e6.js"><link rel="prefetch" href="/MadBOK/assets/js/196.6cbbab5c.js"><link rel="prefetch" href="/MadBOK/assets/js/197.e3ea7caf.js"><link rel="prefetch" href="/MadBOK/assets/js/198.ba630019.js"><link rel="prefetch" href="/MadBOK/assets/js/199.268a2caf.js"><link rel="prefetch" href="/MadBOK/assets/js/20.1d2be093.js"><link rel="prefetch" href="/MadBOK/assets/js/200.927f4357.js"><link rel="prefetch" href="/MadBOK/assets/js/201.32bea7c4.js"><link rel="prefetch" href="/MadBOK/assets/js/202.076dc4f9.js"><link rel="prefetch" href="/MadBOK/assets/js/203.d531e37d.js"><link rel="prefetch" href="/MadBOK/assets/js/204.b914ebf1.js"><link rel="prefetch" href="/MadBOK/assets/js/205.1f998f98.js"><link rel="prefetch" href="/MadBOK/assets/js/206.c493ad19.js"><link rel="prefetch" href="/MadBOK/assets/js/207.435d7c2f.js"><link rel="prefetch" href="/MadBOK/assets/js/208.a025f9aa.js"><link rel="prefetch" href="/MadBOK/assets/js/209.082cb41a.js"><link rel="prefetch" href="/MadBOK/assets/js/21.e7da4151.js"><link rel="prefetch" href="/MadBOK/assets/js/210.15e8fde2.js"><link rel="prefetch" href="/MadBOK/assets/js/211.d19df6a7.js"><link rel="prefetch" href="/MadBOK/assets/js/213.7dc62532.js"><link rel="prefetch" href="/MadBOK/assets/js/214.8e5a120b.js"><link rel="prefetch" href="/MadBOK/assets/js/215.d7e02e20.js"><link rel="prefetch" href="/MadBOK/assets/js/216.f2eb7788.js"><link rel="prefetch" href="/MadBOK/assets/js/217.a69815d0.js"><link rel="prefetch" href="/MadBOK/assets/js/218.4422818b.js"><link rel="prefetch" href="/MadBOK/assets/js/219.0197326f.js"><link rel="prefetch" href="/MadBOK/assets/js/22.a8368ae0.js"><link rel="prefetch" href="/MadBOK/assets/js/220.51b3b572.js"><link rel="prefetch" href="/MadBOK/assets/js/221.2d793eb3.js"><link rel="prefetch" href="/MadBOK/assets/js/222.827a80d7.js"><link rel="prefetch" href="/MadBOK/assets/js/223.775a0e75.js"><link rel="prefetch" href="/MadBOK/assets/js/224.e910fbb7.js"><link rel="prefetch" href="/MadBOK/assets/js/225.d7872710.js"><link rel="prefetch" href="/MadBOK/assets/js/226.cfeda6f5.js"><link rel="prefetch" href="/MadBOK/assets/js/227.096faf96.js"><link rel="prefetch" href="/MadBOK/assets/js/228.4c13e579.js"><link rel="prefetch" href="/MadBOK/assets/js/229.c55546db.js"><link rel="prefetch" href="/MadBOK/assets/js/23.edd66ae2.js"><link rel="prefetch" href="/MadBOK/assets/js/230.43b68bcd.js"><link rel="prefetch" href="/MadBOK/assets/js/231.b350ff47.js"><link rel="prefetch" href="/MadBOK/assets/js/232.682eb41a.js"><link rel="prefetch" href="/MadBOK/assets/js/233.6d207289.js"><link rel="prefetch" href="/MadBOK/assets/js/234.0750745d.js"><link rel="prefetch" href="/MadBOK/assets/js/235.6235d06f.js"><link rel="prefetch" href="/MadBOK/assets/js/236.eff1ae08.js"><link rel="prefetch" href="/MadBOK/assets/js/237.6df5ef90.js"><link rel="prefetch" href="/MadBOK/assets/js/238.b17fed36.js"><link rel="prefetch" href="/MadBOK/assets/js/239.c16b5c53.js"><link rel="prefetch" href="/MadBOK/assets/js/24.4f26db1e.js"><link rel="prefetch" href="/MadBOK/assets/js/240.a11a8cee.js"><link rel="prefetch" href="/MadBOK/assets/js/241.a139f050.js"><link rel="prefetch" href="/MadBOK/assets/js/242.227f7dfd.js"><link rel="prefetch" href="/MadBOK/assets/js/243.9713f56c.js"><link rel="prefetch" href="/MadBOK/assets/js/244.5fedb35a.js"><link rel="prefetch" href="/MadBOK/assets/js/245.43c9aa8b.js"><link rel="prefetch" href="/MadBOK/assets/js/246.40ea2025.js"><link rel="prefetch" href="/MadBOK/assets/js/247.81d99955.js"><link rel="prefetch" href="/MadBOK/assets/js/248.29b7cc68.js"><link rel="prefetch" href="/MadBOK/assets/js/249.87e72893.js"><link rel="prefetch" href="/MadBOK/assets/js/25.dca23f3b.js"><link rel="prefetch" href="/MadBOK/assets/js/250.b3825d9b.js"><link rel="prefetch" href="/MadBOK/assets/js/251.45be35cf.js"><link rel="prefetch" href="/MadBOK/assets/js/252.50214f82.js"><link rel="prefetch" href="/MadBOK/assets/js/253.46556806.js"><link rel="prefetch" href="/MadBOK/assets/js/254.624e839e.js"><link rel="prefetch" href="/MadBOK/assets/js/255.70d32ec0.js"><link rel="prefetch" href="/MadBOK/assets/js/256.dd391e98.js"><link rel="prefetch" href="/MadBOK/assets/js/257.fc831304.js"><link rel="prefetch" href="/MadBOK/assets/js/258.57f32d3c.js"><link rel="prefetch" href="/MadBOK/assets/js/26.3e88dace.js"><link rel="prefetch" href="/MadBOK/assets/js/27.fa645c16.js"><link rel="prefetch" href="/MadBOK/assets/js/28.e19928dd.js"><link rel="prefetch" href="/MadBOK/assets/js/29.bf488751.js"><link rel="prefetch" href="/MadBOK/assets/js/3.f12ca354.js"><link rel="prefetch" href="/MadBOK/assets/js/30.f6c63b84.js"><link rel="prefetch" href="/MadBOK/assets/js/31.3669ddf9.js"><link rel="prefetch" href="/MadBOK/assets/js/32.9db5b257.js"><link rel="prefetch" href="/MadBOK/assets/js/33.a8437ad5.js"><link rel="prefetch" href="/MadBOK/assets/js/34.e032ebdf.js"><link rel="prefetch" href="/MadBOK/assets/js/35.e70be7b6.js"><link rel="prefetch" href="/MadBOK/assets/js/36.041109ce.js"><link rel="prefetch" href="/MadBOK/assets/js/37.4c61ebc1.js"><link rel="prefetch" href="/MadBOK/assets/js/38.ea82bcae.js"><link rel="prefetch" href="/MadBOK/assets/js/39.904a04e9.js"><link rel="prefetch" href="/MadBOK/assets/js/4.4d0c4f93.js"><link rel="prefetch" href="/MadBOK/assets/js/40.d464be43.js"><link rel="prefetch" href="/MadBOK/assets/js/41.058fefb4.js"><link rel="prefetch" href="/MadBOK/assets/js/42.8615a0f8.js"><link rel="prefetch" href="/MadBOK/assets/js/43.64b7a80a.js"><link rel="prefetch" href="/MadBOK/assets/js/44.03a29da0.js"><link rel="prefetch" href="/MadBOK/assets/js/45.556fc3b6.js"><link rel="prefetch" href="/MadBOK/assets/js/46.9e0777d3.js"><link rel="prefetch" href="/MadBOK/assets/js/47.3618940f.js"><link rel="prefetch" href="/MadBOK/assets/js/48.ef790694.js"><link rel="prefetch" href="/MadBOK/assets/js/49.07a17c67.js"><link rel="prefetch" href="/MadBOK/assets/js/5.9c9c1275.js"><link rel="prefetch" href="/MadBOK/assets/js/50.001d3f83.js"><link rel="prefetch" href="/MadBOK/assets/js/51.d7e65e59.js"><link rel="prefetch" href="/MadBOK/assets/js/52.cad2dcc5.js"><link rel="prefetch" href="/MadBOK/assets/js/53.0b8f4665.js"><link rel="prefetch" href="/MadBOK/assets/js/54.8474df6a.js"><link rel="prefetch" href="/MadBOK/assets/js/55.b9957fd3.js"><link rel="prefetch" href="/MadBOK/assets/js/56.b28251f5.js"><link rel="prefetch" href="/MadBOK/assets/js/57.5dc8b0b5.js"><link rel="prefetch" href="/MadBOK/assets/js/58.0f2cebd3.js"><link rel="prefetch" href="/MadBOK/assets/js/59.71ca7534.js"><link rel="prefetch" href="/MadBOK/assets/js/6.27d37a88.js"><link rel="prefetch" href="/MadBOK/assets/js/60.08ef6bca.js"><link rel="prefetch" href="/MadBOK/assets/js/61.06638f8f.js"><link rel="prefetch" href="/MadBOK/assets/js/62.7c58873b.js"><link rel="prefetch" href="/MadBOK/assets/js/63.ab2125e0.js"><link rel="prefetch" href="/MadBOK/assets/js/64.a108cf51.js"><link rel="prefetch" href="/MadBOK/assets/js/65.3fc3d8bf.js"><link rel="prefetch" href="/MadBOK/assets/js/66.38b4dbf4.js"><link rel="prefetch" href="/MadBOK/assets/js/67.210542df.js"><link rel="prefetch" href="/MadBOK/assets/js/68.c7787087.js"><link rel="prefetch" href="/MadBOK/assets/js/69.0adc4e15.js"><link rel="prefetch" href="/MadBOK/assets/js/7.02b09747.js"><link rel="prefetch" href="/MadBOK/assets/js/70.07690973.js"><link rel="prefetch" href="/MadBOK/assets/js/71.8a6f4e27.js"><link rel="prefetch" href="/MadBOK/assets/js/72.637560e9.js"><link rel="prefetch" href="/MadBOK/assets/js/73.53037fdd.js"><link rel="prefetch" href="/MadBOK/assets/js/74.7bbe521d.js"><link rel="prefetch" href="/MadBOK/assets/js/75.dad6d6be.js"><link rel="prefetch" href="/MadBOK/assets/js/76.e93b72e7.js"><link rel="prefetch" href="/MadBOK/assets/js/77.d51c4570.js"><link rel="prefetch" href="/MadBOK/assets/js/78.3e81e1a6.js"><link rel="prefetch" href="/MadBOK/assets/js/79.a32cb9d7.js"><link rel="prefetch" href="/MadBOK/assets/js/8.d0353912.js"><link rel="prefetch" href="/MadBOK/assets/js/80.33ae9679.js"><link rel="prefetch" href="/MadBOK/assets/js/81.ce8e8453.js"><link rel="prefetch" href="/MadBOK/assets/js/82.5f6cc468.js"><link rel="prefetch" href="/MadBOK/assets/js/83.7fed813f.js"><link rel="prefetch" href="/MadBOK/assets/js/84.5e78802a.js"><link rel="prefetch" href="/MadBOK/assets/js/85.039be980.js"><link rel="prefetch" href="/MadBOK/assets/js/86.f952eb40.js"><link rel="prefetch" href="/MadBOK/assets/js/87.086e3e84.js"><link rel="prefetch" href="/MadBOK/assets/js/88.e0e8b1a6.js"><link rel="prefetch" href="/MadBOK/assets/js/89.024f88a1.js"><link rel="prefetch" href="/MadBOK/assets/js/9.80e7071f.js"><link rel="prefetch" href="/MadBOK/assets/js/90.b7294e42.js"><link rel="prefetch" href="/MadBOK/assets/js/91.2212b681.js"><link rel="prefetch" href="/MadBOK/assets/js/92.acdad728.js"><link rel="prefetch" href="/MadBOK/assets/js/93.8803a502.js"><link rel="prefetch" href="/MadBOK/assets/js/94.0cb7d350.js"><link rel="prefetch" href="/MadBOK/assets/js/95.5aafec65.js"><link rel="prefetch" href="/MadBOK/assets/js/96.c718335d.js"><link rel="prefetch" href="/MadBOK/assets/js/97.aea9f64e.js"><link rel="prefetch" href="/MadBOK/assets/js/98.a3f6741f.js"><link rel="prefetch" href="/MadBOK/assets/js/99.3c2373d4.js">
    <link rel="stylesheet" href="/MadBOK/assets/css/0.styles.a5e47809.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MadBOK/" class="home-link router-link-active"><!----> <span class="site-name">MadBOK</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MadBOK/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><span class="title">Other</span> <span class="arrow down"></span></button> <button type="button" aria-label="Other" class="mobile-dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://hanchenhao.github.io/Algorithms-DataStructures-Vuepress/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法与数据结构
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MadBOK/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Other" class="dropdown-title"><span class="title">Other</span> <span class="arrow down"></span></button> <button type="button" aria-label="Other" class="mobile-dropdown-title"><span class="title">Other</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://hanchenhao.github.io/Algorithms-DataStructures-Vuepress/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法与数据结构
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/Agile/前言" class="sidebar-heading clickable"><span>敏捷管理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/Kanban/前言" class="sidebar-heading clickable"><span>看板系统</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/ThinkingInSystem/前言" class="sidebar-heading clickable"><span>系统思考</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/TheModelThinker/前言" class="sidebar-heading clickable"><span>模型思维</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/MiddleOffice/前言" class="sidebar-heading clickable"><span>中台设计方法</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/DomainDrivenDesign/前言" class="sidebar-heading clickable"><span>领域驱动设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/TDD/前言" class="sidebar-heading clickable open"><span>测试驱动开发</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MadBOK/TDD/前言.html" class="sidebar-link">前言</a></li><li><a href="/MadBOK/TDD/TDD演示.html" class="active sidebar-link">TDD演示</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MadBOK/TDD/TDD演示.html#编写失败的测试" class="sidebar-link">编写失败的测试</a></li><li class="sidebar-sub-header"><a href="/MadBOK/TDD/TDD演示.html#修复失败的测试-编写代码" class="sidebar-link">修复失败的测试，编写代码</a></li><li class="sidebar-sub-header"><a href="/MadBOK/TDD/TDD演示.html#重构代码" class="sidebar-link">重构代码</a></li><li class="sidebar-sub-header"><a href="/MadBOK/TDD/TDD演示.html#重组测试策略" class="sidebar-link">重组测试策略</a></li><li class="sidebar-sub-header"><a href="/MadBOK/TDD/TDD演示.html#发现重复代码-继续重构" class="sidebar-link">发现重复代码，继续重构</a></li></ul></li><li><a href="/MadBOK/TDD/TDD中的测试.html" class="sidebar-link">TDD中的测试</a></li><li><a href="/MadBOK/TDD/TDD中的驱动.html" class="sidebar-link">TDD中的驱动</a></li><li><a href="/MadBOK/TDD/TDD流程和优势.html" class="sidebar-link">TDD流程和优势</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/BigData/大数据概述" class="sidebar-heading clickable"><span>大数据理论</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/ArtificialIntelligence/人工智能概述" class="sidebar-heading clickable"><span>人工智能理论</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/DataProductTheory/前言" class="sidebar-heading clickable"><span>数据产品理论</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/DataManagement/前言" class="sidebar-heading clickable"><span>数据管理 </span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/SolutionArchitecture/前言" class="sidebar-heading clickable"><span>解决方案架构</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/Communicate/前言" class="sidebar-heading clickable"><span>沟通技巧</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/SupplyChainManagement/前言" class="sidebar-heading clickable"><span>供应链管理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/CorporateCulture/前言" class="sidebar-heading clickable"><span>企业文化落地</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/CultureIndustry/前言" class="sidebar-heading clickable"><span>从文化资源到文化产业</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/Consultant/前言" class="sidebar-heading clickable"><span>咨询顾问基本功</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/AgileOrganizationDesign/前言" class="sidebar-heading clickable"><span>敏捷组织设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/Coaching/前言" class="sidebar-heading clickable"><span>教练能力</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/WisdomCity/前言" class="sidebar-heading clickable"><span>智慧城市</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/Computing/前言" class="sidebar-heading clickable"><span>计算</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MadBOK/ApsaraClouder/ECS入门" class="sidebar-heading clickable"><span>ApsaraClouder</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tdd演示"><a href="#tdd演示" class="header-anchor">#</a> TDD演示</h1> <p>测试驱动开发，其实就是将软件需求转化为一组自动化测试，然后再根据测试描述的场景，逐步实现软件功能的开发方法。首先，我们试着演示一下如何通过TDD的方式来完成一段完整的功能。在演示前，有一些基本原则要先熟悉一下，<strong>TDD的基本原则是</strong>：</p> <ol><li>当且仅当存在失败的自动化测试时，才开始编写生产代码</li> <li>消除重复</li> <li>消除代码的坏味道</li></ol> <p>根据TDD的原则，其实实际的开发工作也就分成了三部：红/绿/重构：</p> <ul><li><strong>红</strong>：编写一个失败的小测试</li> <li><strong>绿</strong>：让这个测试快速通过</li> <li><strong>重构</strong>：消除上一步中产生的所有重复和坏味道</li></ul> <p>红/绿/重构这个循环关注的是单个测试的层面，它并没有说清楚测试从何而来，也就是如何编写第一个测试，于是尝试才有TDD的人都卡在了不知道如何写测试这个问题上。徐昊总结出了一个任务分解法，并将任务列表作为TDD的核心要素：</p> <ol><li>大致构思软件被使用的方式，把握对外接口的方向</li> <li>大致构思功能的实现方式，划分所需的组件以及组件之间的关系</li> <li>根据需求的功能描述拆分功能点，功能要考虑正确路径、边界条件以及默认缺省值</li> <li>依照组件以及组件间的关系，将功能拆分到对应组件</li> <li>针对拆分的结果编写测试，进入红/绿/重构循环</li></ol> <p><img src="https://static001.geekbang.org/resource/image/17/e4/17482a8f6fb89d85d0c9974414fd7fe4.jpg?wh=2283x1286" alt=""></p> <h2 id="编写失败的测试"><a href="#编写失败的测试" class="header-anchor">#</a> 编写失败的测试</h2> <p>接下来，我会通过 TDD 来实现命令行参数解析的功能。这个练习源自 Robert C. Martin 的 《Clean Code》 第十四章的一个例子。需求描述如下：</p> <blockquote><p>简单地处理一下传入<code>main</code>函数的字符串数组。
传递给程序的参数由标志和值组成。
标志应该是一个字符，前面有一个减号（<code>-</code>）。
每个标志都应该有零个或多个与之相关的值。
例如：<code>-l -p 8080 -d /usr/logs</code> <code>“l”</code>（日志）没有相关的值，它是一个布尔标志，如果存在则为 <code>true</code>，不存在则为 <code>false</code>。
<code>“p”</code>（端口）有一个整数值，<code>“d”</code>（目录）有一个字符串值。
如果参数中没有指定某个标志，那么解析器应该指定一个默认值。</p></blockquote> <p>接下来我们试着结合任务分解法，使用TDD来完成这个需求，首先我们需要考虑别人将以何种方式来使用这段代码，这段代码作为对外的接口，如何调用才能更舒适，在这里，我们可以通过写测试的方法，来感受API的友好程度，我们可以假设功能已经实现了，在测试代码中调用方法来感受这段代码，看一看他整体的风格是不是我们喜欢的，首先我想到了如下这种传统的写法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsTest</span> <span class="token punctuation">{</span>
    <span class="token comment">// -l -p 8080 -d /usr/logs -g this is a list -d 1 2 -3 5</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Argument</span> argument <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;l:boolean,p:int,d:string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/usr/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">getBool</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于当前Java更流行注解，我又想到了下面这种写法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsTest</span> <span class="token punctuation">{</span>
    <span class="token comment">// -l -p 8080 -d /usr/logs -g this is a list -d 1 2 -3 5</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Options</span> options <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">prase</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/usr/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">logging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">Options</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> logging<span class="token punctuation">,</span> <span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> directory<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在确定了API设计的方向之后，我们就可以根据需求的描述来对功能进行分解了，当前需求整体上可以理解为将命令行解析成各个参数，根据这个需求，我们首先想到的就是先实现解析参数，然后再实现解析列表这个过程，根据这个过程形成了如下的测试代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsTest</span> <span class="token punctuation">{</span>
    <span class="token comment">// -l -p 8080 -d /usr/logs -g this is a list -d 1 2 -3 5</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">example_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 输入-l -p 8080 -d /usr/logs，将内容进行分割，并提取参数</span>
        <span class="token class-name">Options</span> options <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">prase</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8080&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/usr/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">logging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">8008</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;/usr/logs&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">example_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 输入g this is a list -d 1 2 -3 5，将内容进行分割，并提取参数列表</span>
        val listOptions <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">prase</span><span class="token punctuation">(</span><span class="token class-name">ListOptions</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-g&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;this&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> listOptions<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> listOptions<span class="token punctuation">.</span><span class="token function">decimals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">Options</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span> <span class="token keyword">boolean</span> logging<span class="token punctuation">,</span> <span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> directory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">ListOptions</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;g&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> group<span class="token punctuation">,</span> <span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decimals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>写完这部分代码时，我们会发现当前测试的颗粒度太大了，并没办法一次性实现并测试通过它。基于此，再将当前的测试拆解，分成先单独解析<code>Boolean</code>、<code>Integer</code>和<code>String</code>这几种类型，然后再合在一起解析。于是形成了如下TODO：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">// happy path</span>
    <span class="token comment">// TODO 输入：-l， 输出：options.logging() = true</span>
    <span class="token comment">// TODO 输入：-p 8080，输出： options.port()=8080</span>
    <span class="token comment">// TODO 输入：-d /usr/logs，输出： options.directory()=/usr/logs</span>
    <span class="token comment">// TODO 输入：-l -p 8080 -d /usr/logs，输出：options（logging=true，port=8080，directory=&quot;/usr/logs&quot;）</span>
    
    <span class="token comment">// default value</span>
    <span class="token comment">// TODO -p 默认=0</span>
    <span class="token comment">// TODO -d 默认=&quot;&quot;</span>
    <span class="token comment">// TODO -l 默认=false</span>
</code></pre></div><p>第一步的测试，我们分别测单一参数的结果是否正确，我们分别单独输入&quot;<code>-l</code>&quot;,&quot;<code>-p 8080</code>&quot;和&quot;<code>-d /usr/logs</code>&quot;,期待能够得到一个正常的结果，测试如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_boolean_option_to_true_if_flag_present</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        val option <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">BooleanOption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span><span class="token function">logging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_boolean_option_to_false_if_flag_present</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        val option <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">BooleanOption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span><span class="token function">logging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">BooleanOption</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span><span class="token keyword">boolean</span> logging<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_int_option_if_flag_present</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        val option <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">IntOption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8080&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span>option<span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_zero_option_if_input_empty_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        val option <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">IntOption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>option<span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">IntOption</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_string_option_if_flag_present</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        val option <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">StringOption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/usr/logs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;/usr/logs&quot;</span><span class="token punctuation">,</span>option<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_get_null_if_input_empty_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        val option <span class="token operator">=</span> <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">StringOption</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;-d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>option<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">record</span> <span class="token class-name">StringOption</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Option</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> directory<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    
</code></pre></div><h2 id="修复失败的测试-编写代码"><a href="#修复失败的测试-编写代码" class="header-anchor">#</a> 修复失败的测试，编写代码</h2> <p>基于测试，可以实现如下代码，实现的思路很简单，就是对着测试逐一使其不再报错，程序运行时将红色的警告转为绿色通过：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> optionsClass<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val constructor <span class="token operator">=</span> optionsClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            val parameter <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            val option <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            val arguments <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果要将参数一并提取，可以基于上述代码进行一定的转化，转化后的<code>parseArguments</code>方法，其实就是由上面一组测试驱动出来的实现代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> optionsClass<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val constructor <span class="token operator">=</span> optionsClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        val arguments <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            val values <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>constructor<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parameter <span class="token operator">-&gt;</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            val instance <span class="token operator">=</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Parameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val option <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="重构代码"><a href="#重构代码" class="header-anchor">#</a> 重构代码</h2> <p>在通过若干次<strong>红/绿循环</strong>后，问你完成了一个可以处理多个参数的功能，此时我们可以看一下代码选择是否重构。是否进入重构有两个先决条件，第一个条件是测试都是通过的，当前功能正常，第二个是可以明显的看到代码中的坏味道。我们目前的代码已经全部通过测试，而且有多个分支语句，看起来可以对其进行重构。<strong>可以使用“利用多态替换条件分支”的的手法对其重构</strong>。在重构的过程中，我们需要保持小步骤且稳定的节奏，不断的运行测试以保证当前的代码不会产生负面影响。</p> <p>我们首先要做的是将分支内的方法抽取出来，使其能够对其进行隔离。第一步，我们可以先将分支语句中的代码，利用接口进行独立实现：</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Parameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val option <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">interface</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BooleanParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> arguments<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">IntParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StringParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这时我们会发现，分支中的代码几乎都是重复的，我们继续抽取：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 抽取前</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Parameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val option <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ArgumentParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ArgumentParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ArgumentParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//抽取后</span>
       <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Parameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val option <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArgumentParser</span> parser <span class="token operator">=</span> <span class="token function">getArgumentParser</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ArgumentParser</span> <span class="token function">getArgumentParser</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentParser</span> parser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//将条件分支抽取成Map，继续重构会得到如下代码</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentParser</span><span class="token punctuation">&gt;</span></span> PARSERS <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Parameter</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PARSERS<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> parameter<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>通过重构，我们消除了代码的坏味道，在保持功能不变的前提下，得到了结构更好的代码。在红/绿测试阶段，我们不关心代码结构，只关注功能的累积，在重构的过程中，因为测试的存在，我们可以时刻检查功能是否收到破坏，同时将注意力转移到如何让代码变得更好上来。</p> <h2 id="重组测试策略"><a href="#重组测试策略" class="header-anchor">#</a> 重组测试策略</h2> <p>重构后，我们会发现当前多了<code>BooleanParser</code>、<code>IntParser</code>、<code>StringParser</code>，这三个类，那我们也应该对这几个类进行测试，测试的内容也主要围绕着正常执行、异常处理和初始化默认值这几个功能来进行构建。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BooleanParserTest</span> <span class="token punctuation">{</span>

    <span class="token comment">// 输入：-l t f，输出：异常提示</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_not_allow_extra_arguments_for_bool_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertThrows</span><span class="token punctuation">(</span><span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">BooleanParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;-l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;t&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_set_a_default_value_for_bool_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BooleanParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">Option</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> <span class="token function">annotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;l&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">IntParserTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_not_allow_extra_arguments_for_bool_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertThrows</span><span class="token punctuation">(</span><span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">IntParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;8080&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;8801&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_set_a_default_value_for_bool_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IntParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">static</span> <span class="token class-name">Option</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> <span class="token function">annotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;p&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">StringParserTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_not_allow_extra_arguments_for_bool_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertThrows</span><span class="token punctuation">(</span><span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">StringParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;/user/asd&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/user/as&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">should_set_a_default_value_for_bool_option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assertions</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">StringParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">static</span> <span class="token class-name">Option</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> <span class="token function">annotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Option</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>不难发现，新一轮的红绿循环又开始了，我们要基于测试的需求，分别对实现类进行完善，使其通过测试：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BooleanParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">IntParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">parseValue</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">StringParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">parseValue</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>功能实现完毕后，我们再跑一下测试，看整体实现对原有的测试是否会产生影响。写到这里，不难发现<code>ArgTest</code>类里的内容，需要根据不同的策略进行重组，要将<code>ArgTest</code>内关于<code>BooleanParser</code>、<code>IntParser</code>、<code>StringParser</code>的测试用例，分别挪到对应匹配的策略中去。这几个策略对应的类，就应该分别包含其happy path、sad path以及default value。</p> <h2 id="发现重复代码-继续重构"><a href="#发现重复代码-继续重构" class="header-anchor">#</a> 发现重复代码，继续重构</h2> <p>实现了<code>IntParser</code>、<code>StringParser</code>这两个类后，我们发现其代码大部分都是重复的，只有个别返回值有一些变化，所以为了处理这种坏味道，我们将继续重构这两个类的代码，并将其合并。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">SingleValuedParser</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> defaultValue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SingleValuedParser</span><span class="token punctuation">(</span><span class="token class-name">Object</span> defaultValue<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultValue <span class="token operator">=</span> defaultValue<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>valueParser <span class="token operator">=</span> valueParser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> defaultValue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        val value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">parseValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> valueParser<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>重构了<code>SingleValuedParser</code>之后，我们再将其与<code>BooleanParser</code>合并：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">class</span> <span class="token class-name">ArgumentParsers</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token keyword">private</span> <span class="token class-name">Object</span> defaultValue<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">private</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">;</span>
    <span class="token keyword">int</span> expectedSize<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ArgumentParsers</span><span class="token punctuation">(</span><span class="token class-name">Object</span> defaultValue<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">,</span> <span class="token keyword">int</span> expectedSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultValue <span class="token operator">=</span> defaultValue<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>valueParser <span class="token operator">=</span> valueParser<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expectedSize <span class="token operator">=</span>expectedSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> defaultValue<span class="token punctuation">;</span>
        val values <span class="token operator">=</span> <span class="token function">values</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> expectedSize <span class="token punctuation">)</span> <span class="token keyword">return</span> defaultValue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> expectedSize<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> expectedSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">parseValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> followingFlag <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">&quot;^-[a-zA-Z-]+$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> arguments<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> followingFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">parseValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> valueParser<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>最后再修改一下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ArgumentParsers</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentParser</span><span class="token punctuation">{</span>

     <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> defaultValue<span class="token punctuation">;</span>
     <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">;</span>
     <span class="token keyword">int</span> expectedSize<span class="token punctuation">;</span>

     <span class="token keyword">public</span> <span class="token class-name">ArgumentParsers</span><span class="token punctuation">(</span><span class="token class-name">Object</span> defaultValue<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">,</span> <span class="token keyword">int</span> expectedSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultValue <span class="token operator">=</span> defaultValue<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>valueParser <span class="token operator">=</span> valueParser<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expectedSize <span class="token operator">=</span> expectedSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token class-name">ArgumentParsers</span>  <span class="token function">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentParsers</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token class-name">ArgumentParsers</span> <span class="token function">unary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> defaultValue<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span>Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> valueParser<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentParsers</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">,</span>valueParser<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanOptionNull</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> defaultValue<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValueSlopOver</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> defaultValue<span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">+</span> expectedSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> valueParser<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isValueSlopOver</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val values <span class="token operator">=</span> <span class="token function">values</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> expectedSize<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> expectedSize<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TooManyArgumentsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanOptionNull</span><span class="token punctuation">(</span><span class="token class-name">Option</span> option<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> option<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;l&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> arguments<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> followingFlag <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">&quot;^-[a-zA-Z-]+$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> arguments<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> followingFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>写到这里不难发现，代码是伴随着测试和重构动态调整的，<strong>它的内容体现了我们最新的认知，它的变化记录了我们认知变化的过程</strong>。这份代码目前看还有很多坏味道，但是这正代表了当前的编码水平，因为有了测试的保护，使得这份代码可以以后在我们编程水平精进后再重构调整。根据这次TDD的演示，我们应该能感受到TDD如下三个特点：</p> <ol><li>将要完成的功能分解成一系列任务，再将任务转化为测试，以测试体现研发进度，将整个开发流程变得有序，以减少无效的劳动。</li> <li>在修改代码时，随时执行测试以验证功能，及时发现错误，降低发现、定位错误的成本，降低修改错误的难度。</li> <li>时刻感受到认知的提升，增强修改代码的自信，降低解决错误的恐惧。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MadBOK/TDD/前言.html" class="prev">
        前言
      </a></span> <span class="next"><a href="/MadBOK/TDD/TDD中的测试.html">
        TDD中的测试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MadBOK/assets/js/app.4af459fe.js" defer></script><script src="/MadBOK/assets/js/2.60cd3182.js" defer></script><script src="/MadBOK/assets/js/212.88c4aee5.js" defer></script>
  </body>
</html>
